<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试新AMS MathSciNet网站 - MRlookup</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            display: none;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            width: 90%;
            max-width: 600px;
        }
        .modal-header {
            background: #f8f9fa;
            border-bottom: 2px solid #ff6b35;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            margin: 0;
            color: #333;
        }
        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .modal-body {
            padding: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .col {
            flex: 1;
        }
        .custom-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-ams-blue {
            background: #007bff;
            color: white;
        }
        .btn-ams-orange {
            background: #ff6b35;
            color: white;
        }
        .btn-primary {
            background: #28a745;
            color: white;
        }
        .citation-text-area-holder {
            margin-top: 15px;
        }
        .citation-text-area {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            text-align: right;
            border-radius: 0 0 8px 8px;
        }
        .mrlookup-message {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>测试新AMS MathSciNet网站 - MRlookup</h1>
        <p>这个页面模拟新的AMS MathSciNet网站的引用格式弹窗，用于测试MRlookup功能。</p>
        
        <div>
            <button class="test-button" onclick="showCitationModal()">显示引用格式弹窗</button>
            <button class="test-button" onclick="showCitationModalWithBibTeX()">显示带BibTeX的弹窗</button>
        </div>
        
        <div id="status" style="margin-top: 20px; padding: 10px; background: #e9ecef; border-radius: 4px;">
            <strong>状态:</strong> 等待测试...
        </div>
    </div>

    <!-- 引用格式弹窗 -->
    <div id="citationModal" class="modal-overlay">
        <div class="modal-content">
            <header class="modal-header">
                <h2 class="modal-title">Citation Formatting</h2>
                <button type="button" aria-label="Close" class="close" onclick="closeCitationModal()">×</button>
            </header>
            <div class="modal-body">
                <div class="d-flex flex-column h-100">
                    <div>Select a format to change the citation preview</div>
                    <fieldset class="form-group" id="__BVID__110">
                        <div>
                            <div class="row">
                                <div class="col">
                                    <select name="Select citation format" class="custom-select" id="__BVID__111" onchange="onFormatChange(this.value)">
                                        <option value="permalink">Permalink</option>
                                        <option value="amsref">AMSRef</option>
                                        <option value="bibtex">BibTeX</option>
                                        <option value="endnote">EndNote</option>
                                        <option value="tex">TeX</option>
                                    </select>
                                </div>
                                <div class="col">
                                    <button title="Copy to clipboard" name="Copy button" type="button" class="btn btn-ams-blue">
                                        <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="copy" role="presentation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" style="width: 14px; height: 14px; margin-right: 5px;">
                                            <path fill="currentColor" d="M320 448v40c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V120c0-13.255 10.745-24 24-24h72v296c0 30.879 25.121 56 56 56h168zm0-344V0H152c-13.255 0-24 10.745-24 24v368c0 13.255 10.745 24 24 24h272c13.255 0 24-10.745 24-24V128H344c-13.2 0-24-10.8-24-24zm120.971-31.029L375.029 7.029A24 24 0 0 0 358.059 0H352v96h96v-6.059a24 24 0 0 0-7.029-16.97z"></path>
                                        </svg>
                                        Copy
                                    </button>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    <div class="h-100">
                        <div class="w-100 citation-text-area-holder">
                            <textarea id="citationText" rows="10" class="citation-text-area" placeholder="选择引用格式以显示内容..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="modal-footer">
                <button name="Close button" type="button" class="btn btn-primary" onclick="closeCitationModal()">Close</button>
            </footer>
        </div>
    </div>

    <script src="test_mrlookup_new_ams.js"></script>
    <script>
        // 模拟引用格式数据
        const citationData = {
            permalink: 'https://mathscinet.ams.org/mathscinet/article?mr=1925341',
            amsref: 'AMSRef: 1925341',
            bibtex: `@article{MR1925341,
    AUTHOR = {Smith, John and Johnson, Mary},
    TITLE = {On the properties of mathematical structures},
    JOURNAL = {Journal of Mathematics},
    VOLUME = {45},
    YEAR = {2008},
    NUMBER = {3},
    PAGES = {123--145},
    ISSN = {1234-5678},
    DOI = {10.1234/jm.2008.45.123},
    MRCLASS = {Primary 11G05; Secondary 14G25},
    MRNUMBER = {1925341}
}`,
            endnote: 'EndNote format citation...',
            tex: '\\cite{MR1925341}'
        };

        function showCitationModal() {
            document.getElementById('citationModal').style.display = 'block';
            document.getElementById('citationText').value = '';
            updateStatus('引用格式弹窗已打开');
        }

        function showCitationModalWithBibTeX() {
            document.getElementById('citationModal').style.display = 'block';
            document.getElementById('citationText').value = citationData.bibtex;
            document.getElementById('__BVID__111').value = 'bibtex';
            updateStatus('引用格式弹窗已打开，包含BibTeX内容');
        }

        function closeCitationModal() {
            document.getElementById('citationModal').style.display = 'none';
            updateStatus('引用格式弹窗已关闭');
        }

        function onFormatChange(format) {
            const textarea = document.getElementById('citationText');
            textarea.value = citationData[format] || '';
            updateStatus(`已切换到 ${format} 格式`);
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = `<strong>状态:</strong> ${message}`;
        }

        // 点击弹窗外部关闭
        document.getElementById('citationModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeCitationModal();
            }
        });

        // 模拟MRlookup功能（如果脚本已加载）
        window.addEventListener('load', function() {
            updateStatus('页面已加载，MRlookup脚本应该会自动检测并增强引用格式弹窗');
            
            // 添加测试按钮
            addTestButtons();
        });

        // 添加测试按钮
        function addTestButtons() {
            const container = document.querySelector('.container');
            
            // 测试功能按钮
            const testSection = document.createElement('div');
            testSection.style.cssText = 'margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;';
            testSection.innerHTML = `
                <h3>测试功能</h3>
                <button onclick="testBibTeXParsing()" class="test-button">测试BibTeX解析</button>
                <button onclick="testStandardization()" class="test-button">测试标准化</button>
                <button onclick="testAutoStandardization()" class="test-button">测试自动标准化</button>
                <div id="test-results" style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-family: monospace; font-size: 12px;"></div>
            `;
            
            container.appendChild(testSection);
        }

        // 测试BibTeX解析
        function testBibTeXParsing() {
            if (window.MRlookupTest) {
                const result = window.MRlookupTest.parseBibTex(citationData.bibtex);
                document.getElementById('test-results').innerHTML = `
                    <strong>BibTeX解析测试:</strong><br>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } else {
                document.getElementById('test-results').innerHTML = '<strong>错误:</strong> MRlookup测试脚本未加载';
            }
        }

        // 测试标准化
        function testStandardization() {
            if (window.MRlookupTest) {
                const parsed = window.MRlookupTest.parseBibTex(citationData.bibtex);
                const standardized = window.MRlookupTest.generateStandardizedBibTeX(parsed);
                document.getElementById('test-results').innerHTML = `
                    <strong>BibTeX标准化测试:</strong><br>
                    <pre>${standardized}</pre>
                `;
            } else {
                document.getElementById('test-results').innerHTML = '<strong>错误:</strong> MRlookup测试脚本未加载';
            }
        }

        // 测试自动标准化
        function testAutoStandardization() {
            if (window.MRlookupTest) {
                const modal = document.querySelector('.modal-content');
                if (modal) {
                    // 模拟选择BibTeX格式
                    const formatSelect = modal.querySelector('select[name="Select citation format"]');
                    if (formatSelect) {
                        formatSelect.value = 'bibtex';
                        // 触发change事件
                        formatSelect.dispatchEvent(new Event('change'));
                        document.getElementById('test-results').innerHTML = '<strong>自动标准化测试:</strong> 已触发，请检查弹窗中的BibTeX是否已自动标准化';
                    } else {
                        document.getElementById('test-results').innerHTML = '<strong>错误:</strong> 未找到格式选择器';
                    }
                } else {
                    document.getElementById('test-results').innerHTML = '<strong>错误:</strong> 未找到引用格式弹窗';
                }
            } else {
                document.getElementById('test-results').innerHTML = '<strong>错误:</strong> MRlookup测试脚本未加载';
            }
        }
    </script>
</body>
</html>
