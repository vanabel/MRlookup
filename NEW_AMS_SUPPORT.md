# MRlookup 新AMS MathSciNet网站支持

## 概述

MRlookup现在完全支持新的AMS MathSciNet网站 (https://mathscinet.ams.org)，包括其新的引用格式弹窗系统。

## 新功能特性

### 1. 自动弹窗检测
- 自动检测引用格式弹窗的出现
- 实时增强新创建的弹窗
- 支持动态加载的内容

### 2. 自动BibTeX标准化
- **无需手动操作**，自动检测并标准化BibTeX内容
- 当选择BibTeX格式时自动触发标准化
- 实时监听内容变化，智能判断是否需要标准化
- 保持原始格式和字段完整性

### 3. 智能格式处理
- 自动检测BibTeX格式选择
- 实时标准化引用内容
- 避免重复标准化（只处理需要标准化的内容）

### 4. 用户反馈系统
- 成功/错误消息提示
- 3秒后自动消失
- 清晰的视觉反馈

## 使用方法

### 在新AMS MathSciNet网站上

1. **访问文章页面**
   - 导航到任意数学文章页面
   - 例如：https://mathscinet.ams.org/mathscinet/article?mr=1925341

2. **打开引用格式弹窗**
   - 查找并点击"Citation Formatting"按钮
   - 弹窗将自动出现

3. **选择BibTeX格式**
   - 在格式下拉菜单中选择"BibTeX"
   - 弹窗将显示BibTeX内容
   - **BibTeX将自动标准化**（无需额外操作）

4. **复制内容**
   - 使用弹窗中的"Copy"按钮复制标准化后的内容
   - 或手动选择文本复制

## 技术实现

### 自动标准化机制
```javascript
// 监听引用格式变化
function observeCitationFormatChange(modal) {
    // 当选择BibTeX格式时自动标准化
    // 无需用户手动操作
}

// 监听文本区域内容变化
function observeTextareaContentChange(modal, textarea) {
    // 实时检测内容变化
    // 智能判断是否需要标准化
}
```

### 自动增强流程
1. 检测弹窗出现
2. 查找关键元素（#citationText）
3. 设置自动标准化监听器
4. 监听格式变化和内容变化
5. 自动执行标准化并提供用户反馈

### 智能检测逻辑
- 检查引用键是否已经是标准格式
- 只对需要标准化的内容进行处理
- 避免重复操作和无限循环

### 兼容性处理
- 检测网站类型（新旧版本）
- 自动选择适当的处理方式
- 保持向后兼容性

## 测试和验证

### 本地测试
使用提供的测试页面：
```bash
# 打开测试页面
open test_new_ams.html

# 测试各项功能
# 1. 显示引用格式弹窗
# 2. 测试BibTeX解析
# 3. 测试标准化功能
# 4. 测试弹窗增强
```

### 功能测试
- BibTeX解析准确性
- 引用键生成正确性
- 弹窗增强稳定性
- 用户交互响应性

## 配置选项

### 模式设置
- **期刊模式**: 使用期刊缩写作为标识符
- **标题模式**: 使用标题关键词作为标识符

### 调试模式
- 启用详细日志输出
- 显示处理过程信息
- 便于问题诊断

## 故障排除

### 常见问题

1. **弹窗未增强**
   - 检查控制台错误信息
   - 确认脚本已正确加载
   - 验证网站URL格式

2. **标准化按钮未出现**
   - 检查弹窗结构是否匹配
   - 确认DOM元素存在
   - 查看控制台日志

3. **BibTeX解析失败**
   - 验证BibTeX格式正确性
   - 检查特殊字符处理
   - 查看解析错误详情

### 调试步骤
1. 打开浏览器开发者工具
2. 查看控制台输出
3. 检查网络请求
4. 验证DOM结构

## 更新日志

### v3.0.5 (最新)
- ✅ 添加新AMS MathSciNet网站支持
- ✅ 实现引用格式弹窗自动检测
- ✅ 集成标准化按钮
- ✅ 添加用户反馈系统
- ✅ 改进错误处理
- ✅ 增强兼容性

### 之前的版本
- v3.0.4: 修复引用键更新问题
- v3.0.3: 改进模式切换
- v3.0.2: 优化键生成逻辑
- v3.0.1: 修复空引用键问题
- v3.0.0: 重大版本更新

## 贡献和反馈

### 报告问题
- 使用GitHub Issues
- 提供详细的错误信息
- 包含复现步骤

### 功能建议
- 描述期望的功能
- 说明使用场景
- 提供示例

### 联系方式
- 邮箱: van141.abel(at)gmail.com
- GitHub: https://github.com/vanabel/mrlookup

## 许可证

本项目采用OSI-SPDX-Short-Identifier许可证。

---

**注意**: 新功能需要MRlookup v3.0.5或更高版本。请确保您的用户脚本已更新到最新版本。
