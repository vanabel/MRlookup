# MRlookup 自动标准化测试指南

## 🔍 问题诊断

根据您提供的控制台日志，弹窗被正确检测和增强了，但BibTeX引用键没有被改变。这可能是以下原因之一：

1. **格式选择器事件未触发**: 选择BibTeX格式时change事件没有正确触发
2. **BibTeX内容未加载**: 文本区域的内容还没有完全加载
3. **解析失败**: BibTeX解析过程中出现错误

## 🛠️ 改进措施

我已经添加了以下改进：

### 1. 增强的调试信息
- 详细的日志输出，显示每个步骤的执行情况
- 显示BibTeX内容和解析结果
- 显示当前引用键和期望的引用键

### 2. 多重触发机制
- 格式选择器change事件
- 文本区域内容变化监听
- 文本区域获得焦点时检查
- 定期检查机制（每2秒）

### 3. 智能重试机制 ⭐ **新功能**
- 选择BibTeX格式后立即尝试标准化
- 如果失败，会在100ms、300ms、500ms、1000ms、2000ms后重试
- 确保即使内容加载较慢也能成功标准化

### 4. 手动触发按钮
- 在每个弹窗中添加"Manual Standardize"按钮
- 用于调试和手动触发标准化

## 🧪 测试步骤

### 步骤1: 检查控制台输出
1. 打开浏览器开发者工具
2. 点击"Cite"链接打开引用弹窗
3. 查看控制台输出，确认弹窗被增强

### 步骤2: 测试自动标准化 ⭐ **关键测试**
1. 在格式下拉菜单中选择"BibTeX"
2. **无需任何手动操作**，系统会自动尝试标准化
3. 查看控制台输出，确认多次尝试的过程
4. 检查引用键是否在几秒内自动标准化

### 步骤3: 使用手动触发（备用方案）
1. 如果自动标准化失败，点击"Manual Standardize"按钮
2. 查看控制台输出，确认手动触发是否成功
3. 检查引用键是否被改变

### 步骤4: 检查定期检查
1. 等待2秒，查看控制台是否有定期检查的输出
2. 确认定期检查是否发现了需要标准化的内容

## 📋 预期控制台输出

成功的自动标准化过程应该显示：

```
[Log] 引用格式已改变: bibtex
[Log] 选择BibTeX格式，立即开始自动标准化
[Log] 开始尝试标准化...
[Log] 第1次尝试标准化，延迟100ms
[Log] 第1次尝试，文本区域内容: @article{MR1925341,...
[Log] 第1次尝试，解析的BibTeX数据: {typeName: "article", citationKey: "MR1925341", ...}
[Log] 第1次尝试，当前引用键: MR1925341
[Log] 第1次尝试，期望的引用键: Smith2008Jou
[Log] 第1次尝试，检测到非标准引用键，开始标准化...
[Log] 第1次尝试，自动标准化完成
```

## 🔧 故障排除

### 问题1: 需要手动点击才能标准化 ❌
**这不是预期行为！** 自动标准化应该在选择BibTeX格式后立即生效。

**解决方案**: 
- 刷新页面，重新加载脚本
- 检查控制台是否有错误信息
- 确认格式选择器的change事件是否被触发

### 问题2: 没有看到多次尝试的日志
**解决方案**:
- 检查`attemptStandardization`函数是否被调用
- 确认格式选择器是否正确找到
- 查看是否有JavaScript错误

### 问题3: 多次尝试都失败
**解决方案**:
- 检查BibTeX格式是否正确
- 查看解析错误的具体信息
- 使用手动触发按钮作为备用方案

## 🎯 关键改进点

### 智能重试机制
- **无需手动点击**：选择BibTeX格式后自动开始
- **多次尝试**：100ms到2000ms的多个时机
- **智能停止**：成功后就停止重试
- **详细日志**：每次尝试都有完整的日志输出

### 预期行为
✅ **选择BibTeX格式** → **立即开始标准化** → **几秒内完成** → **无需手动操作**

❌ **选择BibTeX格式** → **需要手动点击** → **这不是预期行为**

## 📝 测试数据

您可以使用以下测试数据验证功能：

```bibtex
@article{MR1925341,
    AUTHOR = {Smith, John and Johnson, Mary},
    TITLE = {On the properties of mathematical structures},
    JOURNAL = {Journal of Mathematics},
    VOLUME = {45},
    YEAR = {2008},
    NUMBER = {3},
    PAGES = {123--145}
}
```

预期结果：引用键应该从`MR1925341`变为`Smith2008Jou`

## 🎯 下一步

如果问题仍然存在，请：

1. 提供完整的控制台输出
2. 确认BibTeX内容是否正确加载
3. 检查是否有JavaScript错误
4. 尝试手动触发按钮

这样我可以进一步诊断和修复问题。
